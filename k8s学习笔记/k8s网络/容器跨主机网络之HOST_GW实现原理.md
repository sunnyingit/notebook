# 容器跨主机网络之HOST_GW实现原理

容器跨宿主主机访问是指容器访问另一个宿主机上的容器。很显然，最基本的前提是*宿主机之间能相互访问*。

我在[网络知识体系构建]()一文中提到一个设想，我们是否可以动态修改路由表来实现网络的转发。

今天要分享的Flannel 的 host-gw 模式就是通过修改路由表来实现的。


## 路由表
我们先再次复习一下路由表。

"ip route" 命令的输出通常显示操作系统的 IP 路由表，其中列出了每个网络目的地和它们应该使用的下一跳。

以下是一个可能的输出示例：

default via 192.168.1.1 dev eth0 proto static metric 100
10.0.0.0/8 via 192.168.2.1 dev eth1 proto static metric 200
192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.10 metric 100
192.168.2.0/24 dev eth1 proto kernel scope link src 192.168.2.10 metric 200

这个输出中包含了四个路由表项，每个表项由不同的字段组成，解释如下：

1. 目标网络地址：表示数据包要发送到的网络的 IP 地址或地址范围。
2. 下一跳：表示数据包要通过哪个网络接口或路由器发送，可以理解为网关。
3. 设备：表示与下一跳相关联的网络接口。
4. 协议：表示路由表项是由何种协议生成的（例如，静态路由或动态路由）。
5. 度量：表示路由表项的优先级或距离，通常越小越优先。
6. 源IP地址：表示与网络接口相关联的本地IP地址，通常由内核自动添加。


default via 192.168.1.1 dev eth0 proto static metric 100 解释如下：

1. default：表示这是默认路由表项，也就是当没有其他路由表项与目标地址匹配时，应该使用该路由表项发送数据包。
2. via 192.168.1.1：表示下一跳网关的 IP 地址，也就是该数据包要通过哪个网关发送。
3. dev eth0：表示使用哪个网络接口连接到下一跳路由器，这里是使用 eth0 网卡。
4. proto static：表示该路由表项是静态路由，即手动配置的路由，而不是通过动态路由协议自动学习的路由。
5. metric 100：表示该路由表项的度量值，通常用于区分优先级。在默认路由中，通常将度量设置为较小的值，以确保它优先于其他路由表项。


92.168.2.0/24 dev eth1 proto kernel scope link src 192.168.2.10 metric 200 解释如下：

1. proto kernel：表示该路由表项是内核自动生成的路由，也就是由 Linux 内核根据系统配置和网络拓扑自动生成的路由。
2. scope link：表示这个路由表项只适用于本地网络接口，也就是本地主机上的网络设备。
3. src 192.168.2.10：表示这个路由表项的源 IP 地址，用于指定将要使用这个路由的数据包的源地址。

因此，该路由表项的含义是：当需要将数据包发送到 192.168.2.0/24 网络范围内的目标地址时，使用 eth1 网络接口，并将源 IP 地址设置为 192.168.2.10。

由于这是内核自动生成的本地网络路由，因此度量值比静态路由高，为 200。


## 准备工作

我们先构建一个跨主机的网络，如图所示：


                   +------------------------------------------------------+
                   |                 Host1和Host2可以相互访问               |
                   |                                                      |
                   |                                                      |
                   |                                                      |
                   |                                                      |
+----------------------------------------+             +-----------------------------------------+
|  Host1     +------------------+        |             |  Host2    +-------------------+         |
|            |   Eth0           |        |             |           |  Eth0             |         |
|            |                  |        |             |           |                   |         |
|            +------------------+        |             |           +-------------------+         |
|             ip:10.168.0.1/24           |             |            ip:10.168.0.2/24             |
|                                        |             |                                         |
|                                        |             |           +--------------------+        |
|            +------------------+        |             |           |                    |        |
|            |                  |        |             |   +------->  Cni0              <------+ |
|       +---->   Cni0           <------+ |             |   |       |                    |      | |
|       |    |                  |      | |             |   |       +--------------------+      | |
|       |    +------------------+      | |             |   |         ip:192.168.1.1/24         | |
|       |      ip:192.168.0.1/24       | |             |   |                                   | |
|       |                              | |             |   |                                   | |
|       |                              | |             |   | +--------------+  +-------------+ | |
|       |                              | |             |   | |              |  |             | | |
| +-----+-----+         +------------+ | |             |   | |  Container3  |  | Container4  | | |
| |           |         |            | | |             |   +-+              |  |             +-+ |
| | Container1|         | Container2 | | |             |     |              |  |             |   |
| |           |         |            +-+ |             |     +--------------+  +-------------+   |
| |           |         |            |   |             |     ip:192.168.1.2/24  ip:192.168.1.3/24|
| +-----------+         +------------+   |             |                                         |
| ip:192.168.0.2/24     ip:192.168.0.3/24|             |                                         |
+----------------------------------------+             +-----------------------------------------+


这是一个简单的网络拓扑，其中有两个主机Host1和Host2，以及四个容器Container1、Container2、Container3和Container4。

1. Host1和Host2使用10.168.0.0/24子网进行通信。
2. 容器Container1和Container2分别连接到主机Host1的Cni0虚拟交换机上，使用的Bridge模式。
3. 容器Container3和Container4分别连接到主机Host2的Cni0虚拟交换机上，使用Brigde模式。


Cni0虚拟网卡是K8s初始化的时候，在每个宿主机器上创建的网卡，类似于Docker创建的Docker0交换机。

Docker Brigde模式请查看[虚拟网桥和容器网络实现原理]()

## 创建路由规则通信
我们要做的事情是让Container1跨子网访问Container3。

在看[虚拟网桥和容器网络实现原理]()文章中，我们已经分享了Container1访问Host1，Host2访问Container3的原理。

同时，Host1又可以访问Host2，因为他们在同一个子网内。

所以，我们只需要实现：当Container1访问Host1是，Host1把数据转发给Host2就行啦。

怎么转发呢，通过路由表呗。
